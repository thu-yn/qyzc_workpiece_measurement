<!--
  文件名: pose_measurement.launch
  文件作用: 姿态测量系统的ROS启动配置文件
  
  主要功能:
  1. 配置系统运行参数（文件路径、算法参数、功能开关）
  2. 支持两种运行模式（单次处理和交互式处理）
  3. 支持两种处理模式（基础模式和扩展模式）
  4. 支持变换点云保存功能
  5. 提供参数验证和默认值设置
  
  使用方法:
  1. 单次处理: roslaunch pose_measurement pose_measurement.launch reference_pcd:=ref.pcd target_pcd:=target.pcd
  2. 交互模式: roslaunch pose_measurement pose_measurement.launch reference_pcd:=ref.pcd
  3. 扩展模式: 添加 enable_advanced:=true
  4. 变换点云: 添加 enable_transformed_cloud_save:=true
  
  参数调优指南:
  - 小物体: voxel_size:=0.001, icp_max_iter:=200
  - 大物体: voxel_size:=0.01, icp_max_iter:=50
  - 高精度: enable_advanced:=true, enable_downsampling:=false
  - 调试模式: enable_transformed_cloud_save:=true
-->

<launch>
     <!-- ===== 文件路径参数 ===== -->
     
     <!-- 参考点云文件路径（必需参数）-->
     <arg name="reference_pcd" default="" 
          doc="Path to reference point cloud PCD file (required)" />
     
     <!-- 目标点云文件路径（可选，为空时启动交互模式）-->
     <arg name="target_pcd" default="" 
          doc="Path to target point cloud PCD file (optional, empty for interactive mode)" />
     
     <!-- CSV输出文件路径 -->
     <arg name="output_csv" default="/home/moyuan/ny_qyzc_ws/src/pose_measurement/results/measurements.csv" 
          doc="Output CSV file path for measurement results" />
     
     <!-- ===== 核心算法参数 ===== -->
     
     <!-- 体素网格下采样大小（米）-->
     <arg name="voxel_size" default="0.005" 
          doc="Voxel grid size for downsampling (meters). Smaller = higher precision, slower processing" />
     
     <!-- ICP算法最大迭代次数 -->
     <arg name="icp_max_iter" default="100" 
          doc="Maximum iterations for ICP algorithm. More iterations = higher precision, slower processing" />
     
     <!-- ICP变换收敛阈值 -->
     <arg name="icp_epsilon" default="1e-6" 
          doc="Transformation convergence threshold for ICP. Smaller = higher precision" />
     
     <!-- ===== 功能开关参数 ===== -->
     
     <!-- 下采样开关（true启用，false保持原始分辨率）-->
     <arg name="enable_downsampling" default="false" 
          doc="Enable voxel grid downsampling. Disable for maximum precision" />
     
     <!-- 扩展处理模式开关（true启用高级功能，false使用基础模式）-->
     <arg name="enable_advanced" default="true" 
          doc="Enable advanced processing mode with plane removal and clustering" />
     
     <!-- 平面移除开关（仅在扩展模式下有效）-->
     <arg name="enable_plane_removal" default="false" 
          doc="Enable plane removal in advanced mode" />
     
     <!-- 聚类分割开关（仅在扩展模式下有效）-->
     <arg name="enable_clustering" default="false" 
          doc="Enable clustering in advanced mode" />
     
     <!-- CSV输出开关 -->
     <arg name="enable_csv_output" default="true" 
          doc="Enable CSV output for measurement results" />
     
     <!-- ===== 变换点云功能参数 ===== -->
     
     <!-- 变换点云保存开关 -->
     <arg name="enable_transformed_cloud_save" default="true" 
          doc="Enable saving transformed point clouds for visualization and comparison" />
     
     <!-- 变换点云输出目录 -->
     <arg name="transformed_cloud_output_dir" default="/home/moyuan/ny_qyzc_ws/src/pose_measurement/debug/" 
          doc="Output directory for transformed point clouds" />
     
     <!-- ===== 节点启动配置 ===== -->
     
     <node name="pose_measurement_node" pkg="pose_measurement" type="pose_measurement_node" output="screen" required="true">
       
          <!-- 文件路径参数传递 -->
          <param name="reference_pcd_path" value="$(arg reference_pcd)" />
          <param name="target_pcd_path" value="$(arg target_pcd)" />
          <param name="output_csv_path" value="$(arg output_csv)" />
          
          <!-- 核心算法参数传递 -->
          <param name="voxel_size" value="$(arg voxel_size)" type="double" />
          <param name="icp_max_iterations" value="$(arg icp_max_iter)" type="int" />
          <param name="icp_transformation_epsilon" value="$(arg icp_epsilon)" type="double" />
          
          <!-- 功能开关参数传递 -->
          <param name="enable_downsampling" value="$(arg enable_downsampling)" type="bool" />
          <param name="enable_advanced_processing" value="$(arg enable_advanced)" type="bool" />
          <param name="enable_plane_removal" value="$(arg enable_plane_removal)" type="bool" />
          <param name="enable_clustering" value="$(arg enable_clustering)" type="bool" />
          <param name="enable_csv_output" value="$(arg enable_csv_output)" type="bool" />
          
          <!-- 变换点云功能参数传递 -->
          <param name="enable_transformed_cloud_save" value="$(arg enable_transformed_cloud_save)" type="bool" />
          <param name="transformed_cloud_output_dir" value="$(arg transformed_cloud_output_dir)" type="str" />
       
     </node>
     
</launch>
   
<!-- 
=== 使用示例 ===

1. 基础单次处理（快速模式）:
roslaunch pose_measurement pose_measurement.launch \
     reference_pcd:=/path/to/reference.pcd \
     target_pcd:=/path/to/target.pcd

2. 高精度单次处理（无下采样）:
roslaunch pose_measurement pose_measurement.launch \
     reference_pcd:=/path/to/reference.pcd \
     target_pcd:=/path/to/target.pcd \
     enable_downsampling:=false \
     icp_max_iter:=200

3. 扩展模式处理（高级功能）:
roslaunch pose_measurement pose_measurement.launch \
     reference_pcd:=/path/to/reference.pcd \
     target_pcd:=/path/to/target.pcd \
     enable_advanced:=true

4. 调试模式（包含变换点云保存）:
roslaunch pose_measurement pose_measurement.launch \
     reference_pcd:=/path/to/reference.pcd \
     target_pcd:=/path/to/target.pcd \
     enable_advanced:=true \
     enable_transformed_cloud_save:=true \
     transformed_cloud_output_dir:=/path/to/debug_results/

5. 交互模式（连续处理多个文件）:
roslaunch pose_measurement pose_measurement.launch \
     reference_pcd:=/path/to/reference.pcd \
     enable_transformed_cloud_save:=true

6. 小物体高精度处理:
roslaunch pose_measurement pose_measurement.launch \
     reference_pcd:=small_ref.pcd \
     target_pcd:=small_target.pcd \
     voxel_size:=0.001 \
     icp_max_iter:=200 \
     enable_advanced:=true \
     enable_downsampling:=false

7. 大物体快速处理:
roslaunch pose_measurement pose_measurement.launch \
     reference_pcd:=large_ref.pcd \
     target_pcd:=large_target.pcd \
     voxel_size:=0.01 \
     icp_max_iter:=50

=== 参数调优指南 ===

体素大小 (voxel_size):
- 0.001-0.003m: 小物体(<10cm)，高精度需求
- 0.003-0.008m: 中等物体(10-50cm)，平衡模式
- 0.008-0.02m:  大物体(>50cm)，快速处理

ICP迭代次数 (icp_max_iter):
- 50-100:  快速模式，适合实时应用
- 100-200: 精确模式，适合质量检测
- 200-500: 高精度模式，适合科研分析

处理模式选择:
- 基础模式: 快速处理，适合批量检测
- 扩展模式: 完整流水线，适合复杂场景

下采样策略:
- 启用: 大点云，速度优先
- 禁用: 小点云或精度优先

变换点云保存:
- 开发调试: 启用，便于可视化验证
- 生产环境: 禁用，节省存储空间
- 质量检查: 启用，便于人工检验

=== 故障排除 ===

1. 配准失败 (高RMSE):
     - 尝试启用扩展模式: enable_advanced:=true
     - 减小体素大小: voxel_size:=0.003
     - 增加ICP迭代: icp_max_iter:=200

2. 处理速度慢:
     - 增大体素大小: voxel_size:=0.01
     - 减少ICP迭代: icp_max_iter:=50
     - 禁用扩展模式: enable_advanced:=false

3. 精度不足:
     - 禁用下采样: enable_downsampling:=false
     - 减小体素大小: voxel_size:=0.001
     - 启用扩展模式: enable_advanced:=true
     - 增加ICP迭代: icp_max_iter:=300

4. 变换点云保存失败:
     - 检查输出目录权限
     - 确保目录存在: mkdir -p /path/to/output/
     - 检查磁盘空间

5. 内存不足:
     - 启用下采样: enable_downsampling:=true
     - 增大体素大小: voxel_size:=0.008
     - 禁用变换点云保存: enable_transformed_cloud_save:=false

=== 输出文件说明 ===

CSV文件包含列:
- filename: 输入文件名
- processing_time: 处理时间(秒)
- downsampling_enabled: 是否启用下采样
- tx,ty,tz: 平移量(米)
- roll,pitch,yaw: 旋转角度(度)
- length,width,height: 几何尺寸(米)
- volume: 体积(立方米)
- surface_area: 表面积(平方米)
- fitness: 配准适配度
- rmse: 配准均方根误差(米)
- transformed_cloud_path: 变换点云保存路径(如果启用)

变换点云文件命名规则:
- transformed_[原文件名]_[时间戳].pcd
- 保存在指定的输出目录中
- 二进制PCD格式，文件较小，加载快速

=== 系统要求 ===

硬件要求:
- CPU: 4核以上，推荐8核
- 内存: 8GB以上，推荐16GB
- 存储: SSD推荐，足够空间存储结果

软件依赖:
- ROS Melodic/Noetic
- PCL 1.10+
- Eigen3
- CMake 3.0.2+

性能优化建议:
- 使用SSD存储提高I/O性能
- 充足内存避免交换分区使用
- 多核CPU可并行处理多个文件
- 根据点云大小调整参数平衡速度和精度

-->